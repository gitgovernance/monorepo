{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "feedback_record_schema.json",
  "title": "FeedbackRecord",
  "description": "Canonical schema for feedback records â€” the structured conversation about work.",
  "additionalProperties": false,
  "type": "object",
  "required": [
    "id",
    "entityType",
    "entityId",
    "type",
    "status",
    "content"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^\\d{10}-feedback-[a-z0-9-]{1,50}$",
      "maxLength": 70,
      "description": "Unique identifier for the feedback entry (10 timestamp + 1 dash + 8 'feedback' + 1 dash + max 50 slug = 70 max)",
      "examples": [
        "1752788100-feedback-blocking-rest-api",
        "1752788400-feedback-question-test-coverage"
      ]
    },
    "entityType": {
      "type": "string",
      "enum": [
        "actor",
        "agent",
        "task",
        "execution",
        "feedback",
        "cycle",
        "workflow"
      ],
      "description": "The type of entity this feedback refers to."
    },
    "entityId": {
      "type": "string",
      "minLength": 1,
      "maxLength": 256,
      "description": "The ID of the entity this feedback refers to.\nMust match the ID pattern for its entityType:\n- actor: ^(human|agent)(:[a-z0-9-]+)+$\n- agent: ^agent(:[a-z0-9-]+)+$\n- task: ^\\d{10}-task-[a-z0-9-]{1,50}$\n- execution: ^\\d{10}-exec-[a-z0-9-]{1,50}$\n- feedback: ^\\d{10}-feedback-[a-z0-9-]{1,50}$\n- cycle: ^\\d{10}-cycle-[a-z0-9-]{1,50}$\n- workflow: ^\\d{10}-workflow-[a-z0-9-]{1,50}$\n",
      "examples": [
        "1752274500-task-implementar-oauth",
        "1752642000-exec-subtarea-9-4",
        "1752788100-feedback-blocking-rest-api",
        "human:camilo"
      ]
    },
    "type": {
      "type": "string",
      "enum": [
        "blocking",
        "suggestion",
        "question",
        "approval",
        "clarification",
        "assignment"
      ],
      "description": "The semantic intent of the feedback."
    },
    "status": {
      "type": "string",
      "enum": [
        "open",
        "acknowledged",
        "resolved",
        "wontfix"
      ],
      "description": "The lifecycle status of the feedback.\nFeedbackRecords are immutable. To change status, create a new FeedbackRecord\nthat references this one using entityType: \"feedback\" and resolvesFeedbackId.\n"
    },
    "content": {
      "type": "string",
      "minLength": 1,
      "description": "The content of the feedback."
    },
    "assignee": {
      "type": "string",
      "pattern": "^(human|agent)(:[a-z0-9-]+)+$",
      "maxLength": 256,
      "description": "Optional. The Actor ID responsible for addressing the feedback (e.g., 'human:maria', 'agent:camilo:cursor').",
      "examples": [
        "human:maria",
        "agent:code-reviewer",
        "agent:camilo:cursor"
      ]
    },
    "resolvesFeedbackId": {
      "type": "string",
      "pattern": "^\\d{10}-feedback-[a-z0-9-]{1,50}$",
      "maxLength": 70,
      "description": "Optional. The ID of another FeedbackRecord that this one resolves or responds to.",
      "examples": [
        "1752788100-feedback-blocking-rest-api"
      ]
    },
    "metadata": {
      "type": "object",
      "additionalProperties": true,
      "description": "Optional structured data for machine consumption.\nUse this field for domain-specific data that needs to be programmatically processed.\nCommon use cases: waiver details (fingerprint, ruleId, file, line), approval context, assignment metadata.\n"
    }
  },
  "allOf": [
    {
      "if": {
        "required": [
          "entityType"
        ],
        "properties": {
          "entityType": {
            "const": "actor"
          }
        }
      },
      "then": {
        "properties": {
          "entityId": {
            "type": "string",
            "pattern": "^(human|agent)(:[a-z0-9-]+)+$"
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "entityType"
        ],
        "properties": {
          "entityType": {
            "const": "agent"
          }
        }
      },
      "then": {
        "properties": {
          "entityId": {
            "type": "string",
            "pattern": "^agent(:[a-z0-9-]+)+$"
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "entityType"
        ],
        "properties": {
          "entityType": {
            "const": "task"
          }
        }
      },
      "then": {
        "properties": {
          "entityId": {
            "type": "string",
            "pattern": "^\\d{10}-task-[a-z0-9-]{1,50}$"
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "entityType"
        ],
        "properties": {
          "entityType": {
            "const": "execution"
          }
        }
      },
      "then": {
        "properties": {
          "entityId": {
            "type": "string",
            "pattern": "^\\d{10}-exec-[a-z0-9-]{1,50}$"
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "entityType"
        ],
        "properties": {
          "entityType": {
            "const": "feedback"
          }
        }
      },
      "then": {
        "properties": {
          "entityId": {
            "type": "string",
            "pattern": "^\\d{10}-feedback-[a-z0-9-]{1,50}$"
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "entityType"
        ],
        "properties": {
          "entityType": {
            "const": "cycle"
          }
        }
      },
      "then": {
        "properties": {
          "entityId": {
            "type": "string",
            "pattern": "^\\d{10}-cycle-[a-z0-9-]{1,50}$"
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "entityType"
        ],
        "properties": {
          "entityType": {
            "const": "workflow"
          }
        }
      },
      "then": {
        "properties": {
          "entityId": {
            "type": "string",
            "pattern": "^\\d{10}-workflow-[a-z0-9-]{1,50}$"
          }
        }
      }
    }
  ],
  "examples": [
    {
      "id": "1752788100-feedback-blocking-rest-api",
      "entityType": "execution",
      "entityId": "1752642000-exec-subtarea-9-4",
      "type": "blocking",
      "status": "open",
      "content": "This implementation does not comply with the REST endpoint standard. Endpoints must follow the /api/v1/{resource}/{id} pattern. Currently uses /get-user?id=X which is not RESTful."
    },
    {
      "id": "1752788200-feedback-rest-api-fixed",
      "entityType": "feedback",
      "entityId": "1752788100-feedback-blocking-rest-api",
      "type": "clarification",
      "status": "resolved",
      "content": "Fix implemented. All endpoints now follow REST standard: GET /api/v1/users/:id, POST /api/v1/users, etc. Tests updated and passing.",
      "resolvesFeedbackId": "1752788100-feedback-blocking-rest-api"
    },
    {
      "id": "1752788300-feedback-assign-auth-task",
      "entityType": "task",
      "entityId": "1752274500-task-implementar-oauth",
      "type": "assignment",
      "status": "open",
      "content": "Assigning this task to Maria for her experience with OAuth2. High priority for the current sprint.",
      "assignee": "human:maria"
    },
    {
      "id": "1752788400-feedback-question-test-coverage",
      "entityType": "task",
      "entityId": "1752274500-task-implementar-oauth",
      "type": "question",
      "status": "open",
      "content": "What level of test coverage is expected for this feature? The spec does not mention it explicitly. Should we aim for 80% like the rest of the project?"
    }
  ]
}