{
  "header": {
    "version": "1.0",
    "type": "task",
    "payloadChecksum": "6b536e67a3b8e248cf9fb71793a0a992e244f4fc1e0fb3ccdcfcbd0a8f145bfa",
    "signatures": [
      {
        "keyId": "human:camilo-v2",
        "role": "author",
        "notes": "Record signed",
        "signature": "peNaWTKHbPLnHhgaAYbuBT0rzWQ5wAXYPDGazsbMpYEH0rFSNmKVlgXWnaVaiZoI5UfpTJLziGbml2wQABoOBQ==",
        "timestamp": 1763336054
      },
      {
        "keyId": "human:camilo-v2",
        "role": "author",
        "notes": "Record signed",
        "signature": "wm7Xe+B7klaQ3h8DmS6pPFFOO1feO9k41UjKH3kfvJTIkudhFzOGOTCYKF03gS1pp3XdTElnD00ejk4fUQqXBg==",
        "timestamp": 1763344809
      }
    ]
  },
  "payload": {
    "id": "1763336054-task-implementar-json-schemas-y-validators-para-configs",
    "title": "Implement JSON Schemas and Validators for Config/Session",
    "status": "draft",
    "priority": "high",
    "description": "# Implementar JSON Schemas y Validators para Config/Session\n\n## üìã Contexto\n\nLos archivos `config.json` y `.session.json` est√°n documentados en:\n- `packages/blueprints/03_products/protocol/99_appendices/config_file.md`\n- `packages/blueprints/03_products/protocol/99_appendices/session_state.md`\n\nSin embargo, **NO existen los JSON Schemas f√≠sicos** ni los validators TypeScript que permitan:\n1. Validar estructura de config/session al cargar\n2. Detectar configuraciones inv√°lidas o corrompidas\n3. Proveer type guards y validaci√≥n detallada\n4. Consumir estos schemas desde otros m√≥dulos (ej: SyncModule)\n\nEl `ConfigManager` actualmente tiene m√©todos `validateConfig()` y `migrateConfig()` marcados como **FALTANTES** (ver `config_session_module.md` l√≠neas 31-32).\n\n## üéØ Objetivo\n\nCrear la infraestructura completa de JSON Schemas y validators para config/session siguiendo el patr√≥n establecido en `validator_module.md`.\n\n## üì¶ Entregables\n\n### 1. JSON Schemas (Source of Truth)\n\n**Archivos a crear:**\n\n```\npackages/core/src/schemas/config_schema.json\npackages/core/src/schemas/session_state_schema.json\n```\n\n**Estructura de `config_schema.json`:**\n- Validar todos los campos de `config.json` seg√∫n `config_file.md`\n- Campos obligatorios: `protocolVersion`, `projectId`, `projectName`, `rootCycle`\n- Secci√≥n `state.branch` (obligatorio: `\"gitgov-state\"`)\n- Secci√≥n `state.sync` con validaci√≥n de strategy, maxRetries, intervals\n- Secci√≥n `state.defaults` para pullScheduler y fileWatcher\n- Validaciones:\n  - `protocolVersion` debe ser semver v√°lido\n  - `strategy` enum: `[\"manual\", \"immediate\", \"batched\"]`\n  - `maxRetries`: integer 1-10\n  - `pushIntervalSeconds`: integer 10-3600\n  - `batchIntervalSeconds`: integer 30-600\n\n**Estructura de `session_state_schema.json`:**\n- Validar todos los campos de `.session.json` seg√∫n `session_state.md`\n- Secci√≥n `cloud` con `sessionToken` (string, opcional)\n- Secci√≥n `lastSession` con `actorId` y `timestamp` ISO 8601\n- Secci√≥n `actorState` (objeto din√°mico por actor):\n  - `activeTaskId` (string, opcional)\n  - `activeCycleId` (string, opcional)\n  - `syncStatus` (opcional):\n    - `lastSyncPush` (ISO 8601, opcional)\n    - `lastSyncPull` (ISO 8601, opcional)\n    - `status` enum: `[\"synced\", \"pending\", \"conflict\"]`\n- Secci√≥n `syncPreferences` (opcional):\n  - `pullScheduler` con enabled, pullIntervalSeconds, etc.\n  - `fileWatcher` con enabled, debounceMs, ignoredPatterns\n\n### 2. TypeScript Validators (Siguiendo patr√≥n de `validator_module.md`)\n\n**Archivos a crear:**\n\n```\npackages/core/src/validation/config_validator.ts\npackages/core/src/validation/session_state_validator.ts\n```\n\n**Cada validator debe implementar:**\n\n```typescript\n// Patr√≥n est√°ndar de validator_module.md\n\n// 1. Type Guards\nexport function isGitGovConfig(obj: unknown): obj is GitGovConfig;\nexport function isGitGovSession(obj: unknown): obj is GitGovSession;\n\n// 2. Schema Validation (AJV raw errors)\nexport function validateConfigSchema(\n  data: unknown\n): [boolean, ValidateFunction['errors']];\n\nexport function validateSessionStateSchema(\n  data: unknown\n): [boolean, ValidateFunction['errors']];\n\n// 3. Detailed Validation (formatted errors for UX)\nexport function validateConfigDetailed(data: unknown): {\n  isValid: boolean;\n  errors: FormattedError[];\n};\n\nexport function validateSessionStateDetailed(data: unknown): {\n  isValid: boolean;\n  errors: FormattedError[];\n};\n```\n\n**Integraci√≥n con SchemaValidationCache:**\n- Usar `SchemaValidationCache.getValidatorFromSchema()` para obtener validators compilados\n- Cacheo autom√°tico para performance (no recompilar en cada validaci√≥n)\n- Seguir patr√≥n de `actor_validator.ts`, `task_validator.ts`, etc.\n\n### 3. Actualizar ConfigManager\n\n**Archivo a modificar:**\n```\npackages/core/src/config/index.ts\n```\n\n**M√©todos a implementar:**\n\n```typescript\n// ConfigManager class\n\n/**\n * Valida configuraci√≥n completa contra schema\n * @throws {DetailedValidationError} si configuraci√≥n es inv√°lida\n */\nasync validateConfig(): Promise<void> {\n  const config = await this.loadConfig();\n  if (!config) {\n    throw new Error('Config file not found');\n  }\n  \n  const result = validateConfigDetailed(config);\n  if (!result.isValid) {\n    throw new DetailedValidationError(\n      'Invalid config.json structure',\n      result.errors\n    );\n  }\n}\n\n/**\n * Valida session state contra schema\n * @throws {DetailedValidationError} si session es inv√°lida\n */\nasync validateSession(): Promise<void> {\n  const session = await this.loadSession();\n  if (!session) {\n    throw new Error('Session file not found');\n  }\n  \n  const result = validateSessionStateDetailed(session);\n  if (!result.isValid) {\n    throw new DetailedValidationError(\n      'Invalid .session.json structure',\n      result.errors\n    );\n  }\n}\n```\n\n### 4. Tests (Cobertura completa EARS)\n\n**Archivos a crear:**\n\n```\npackages/core/src/validation/config_validator.test.ts\npackages/core/src/validation/session_state_validator.test.ts\n```\n\n**Test cases m√≠nimos (siguiendo EARS de validator_module.md):**\n\n- **[EARS-1]** Schema validation debe fallar con config inv√°lido\n- **[EARS-2]** Schema validation debe pasar con config v√°lido\n- **[EARS-3]** Type guard debe retornar `true` para v√°lidos\n- **[EARS-4]** Type guard debe retornar `false` para inv√°lidos\n- **[EARS-5]** validateDetailed debe retornar errores formateados\n- **[EARS-6]** validateDetailed debe validar campos opcionales correctamente\n- **[EARS-7]** validateDetailed debe validar enums (strategy, status)\n- **[EARS-8]** validateDetailed debe validar rangos num√©ricos (maxRetries, intervals)\n- **[EARS-9]** Schema cache debe funcionar correctamente (performance)\n- **[EARS-10]** Validaci√≥n debe fallar con protocolVersion inv√°lido\n- **[EARS-11]** Validaci√≥n debe fallar con campos obligatorios faltantes\n- **[EARS-12]** Session state debe validar actorState din√°mico correctamente\n- **[EARS-13]** syncPreferences debe validar pullScheduler y fileWatcher\n\n**Tests de integraci√≥n en ConfigManager:**\n\n```\npackages/core/src/config/config_manager.test.ts (expandir)\n```\n\n- Validar que `validateConfig()` detecta configs corruptos\n- Validar que `validateSession()` detecta sessions corruptos\n- Validar que `loadConfig()` falla gracefully con config inv√°lido\n- Validar que `loadSession()` falla gracefully con session inv√°lido\n\n### 5. Actualizar Interfaces TypeScript\n\n**Archivo a verificar/actualizar:**\n```\npackages/core/src/types/config.ts\n```\n\nAsegurar que interfaces `GitGovConfig` y `GitGovSession` est√©n 100% alineadas con los JSON Schemas creados.\n\n## üîó Referencias T√©cnicas\n\n**Blueprints:**\n- `packages/blueprints/03_products/protocol/99_appendices/config_file.md` - Especificaci√≥n de config.json\n- `packages/blueprints/03_products/protocol/99_appendices/session_state.md` - Especificaci√≥n de .session.json\n- `packages/blueprints/03_products/core/specs/modules/config_session_module.md` - ConfigManager API\n- `packages/blueprints/03_products/core/specs/validator_module.md` - Patr√≥n de validaci√≥n\n\n**Implementaci√≥n de referencia (copiar patr√≥n):**\n- `packages/core/src/validation/actor_validator.ts` - Ejemplo de validator completo\n- `packages/core/src/validation/task_validator.ts` - Ejemplo de validator completo\n- `packages/core/src/schemas/actor_record_schema.json` - Ejemplo de JSON Schema\n- `packages/core/src/schemas/schema_cache.ts` - Cache de validators AJV\n\n## ‚úÖ Criterios de Aceptaci√≥n\n\n1. ‚úÖ Existen archivos f√≠sicos `config_schema.json` y `session_state_schema.json`\n2. ‚úÖ JSON Schemas validan 100% de los campos documentados en blueprints\n3. ‚úÖ Validators TypeScript implementan las 3 funciones est√°ndar (isType, validateSchema, validateDetailed)\n4. ‚úÖ ConfigManager tiene m√©todos `validateConfig()` y `validateSession()` funcionales\n5. ‚úÖ Tests cubren EARS 1-13 con 100% coverage\n6. ‚úÖ Schemas usan SchemaValidationCache para performance\n7. ‚úÖ C√≥digo sigue patr√≥n de validator_module.md (consistencia)\n8. ‚úÖ Documentaci√≥n inline (JSDoc) explica prop√≥sito de cada funci√≥n\n\n## üö® Consideraciones Importantes\n\n1. **JSON Schema es SOURCE OF TRUTH:** Interfaces TypeScript se derivan del schema, no al rev√©s\n2. **No tocar epic collaboration_system:** Esta task es independiente, los schemas se consumir√°n despu√©s\n3. **Seguir patr√≥n existente:** Copiar estructura de `actor_validator.ts`, NO inventar nuevo patr√≥n\n4. **Validaci√≥n estricta:** Mejor fallar con error claro que aceptar config corrupto\n5. **Performance:** Usar SchemaValidationCache para evitar recompilaci√≥n de schemas\n6. **Backwards compatibility:** Considerar versionado de schemas para futuras migraciones\n\n## üìä Impacto Esperado\n\n**M√≥dulos que se beneficiar√°n:**\n- ‚úÖ `ConfigManager` - Validaci√≥n robusta de config/session\n- ‚úÖ `SyncModule` - Consumir√° `sync_config_schema.json` (futuro)\n- ‚úÖ `CLI init` - Validar√° config generado al inicializar proyecto\n- ‚úÖ `CLI status` - Validar√° session state antes de mostrar dashboard\n- ‚úÖ Todos los m√≥dulos que lean config/session\n\n**Problemas que se previenen:**\n- ‚ùå Configs corruptos causando crashes silenciosos\n- ‚ùå Typos en config.json causando comportamiento inesperado\n- ‚ùå Session state inv√°lido causando errores cr√≠pticos\n- ‚ùå Falta de validaci√≥n de rangos num√©ricos (maxRetries negativo, intervals inv√°lidos)\n\n## üèÅ Resultado Final\n\nInfraestructura completa de validaci√≥n para config/session que:\n1. Sigue patr√≥n establecido de validator_module.md\n2. Provee JSON Schemas como SOURCE OF TRUTH\n3. Permite consumo desde otros m√≥dulos (ej: SyncModule)\n4. Mejora robustez del sistema con validaci√≥n temprana\n5. Facilita debugging con errores formateados user-friendly",
    "tags": [
      "category:infrastructure",
      "package:core",
      "skill:typescript",
      "skill:json-schema",
      "skill:ajv",
      "module:config",
      "module:validator"
    ],
    "references": [],
    "cycleIds": [
      "1763344784-cycle-tareas-hurfanas-consolidadas"
    ]
  }
}