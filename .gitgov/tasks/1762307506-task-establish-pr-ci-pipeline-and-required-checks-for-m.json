{
  "header": {
    "version": "1.0",
    "type": "task",
    "payloadChecksum": "c54122a17761c9ba33345a43362dc1e616afbfe163c8e15b599985d4fafa6cf6",
    "signatures": [
      {
        "keyId": "human:camilo",
        "role": "author",
        "notes": "Task created",
        "signature": "w5isw/p7s8SsjtszFoxeYzOl5mZjyyVRd6XdlUJRBWhzFvSCeSfRyKrDy1Onw2D0aDpDHEwH1fnSLY2YHYiPDQ==",
        "timestamp": 1762658229
      },
      {
        "keyId": "human:camilo-v2",
        "role": "author",
        "notes": "Record signed",
        "signature": "uf+p5gfVv/+TjXAfMLqcCf6VITc3PWNnoD5po+llvhrlUDSUkMvolPn6TRB0QQHsgVCI1XHo1F2HDsV2apAaCw==",
        "timestamp": 1763344818
      }
    ]
  },
  "payload": {
    "id": "1762307506-task-establish-pr-ci-pipeline-and-required-checks-for-m",
    "title": "Establish PR CI pipeline and required checks for main",
    "status": "draft",
    "priority": "high",
    "description": "# Task: Establish CI Pipeline and Required Checks for `main`\n\n## Summary\nCreate a lightweight but reliable Continuous Integration (CI) workflow that runs on every Pull Request targeting `main`. The workflow must validate code quality and prevent risky merges by enforcing **required checks** in a GitHub Ruleset.\n\nThis document is intended to be used as a long description when creating a governance task (e.g., with `--description-file /tmp/ci-task.md`).\n\n---\n\n## Objectives\n1. **Prevent broken code** from being merged into `main`.\n2. **Provide fast feedback** to contributors (target: < 10 minutes for PR CI).\n3. **Align with Ruleset protections** by supplying named checks that can be marked as _required_.\n4. **Do not publish artifacts or releases** from PRs. Releases remain on `push` to `main` via existing release workflows.\n\n---\n\n## Scope\n- Add a new workflow: `.github/workflows/ci.yml`.\n- Run on `pull_request` to `main` (and optionally on `push` to `main` for visibility).\n- Include the following validation steps:\n  - **Lint**\n  - **Type check**\n  - **Build**\n  - **Unit tests**\n  - (Optional) **Dependency audit**, **Prettier check**, **Size limit**\n\n- Expose each validation as a **separate job** so they appear as distinct checks in the Ruleset.\n- Keep the CI **idempotent and safe** (no publishing, no environment mutations).\n\nOut of scope: release automation, deployment, environment provisioning.\n\n---\n\n## Acceptance Criteria\n- A new workflow file exists at `.github/workflows/ci.yml`.\n- Opening a PR against `main` triggers the workflow.\n- The workflow publishes the following check names (jobs):\n  - `lint`\n  - `typecheck`\n  - `build`\n  - `test`\n  - (optional) `audit`\n- The repository’s Ruleset for `main` has **Require status checks to pass** enabled and includes the above jobs as **required checks**.\n- **Require branches to be up to date before merging** is enabled in the Ruleset.\n- The workflow completes in **≤ 10 minutes** under typical loads.\n- The workflow does **not** publish or release anything on PRs.\n\n---\n\n## Design & Implementation Details\n\n### Triggers\n- `pull_request` → `branches: [ main ]`\n- Optional: `push` to `main` for post-merge visibility.\n\n### Permissions\nUse least privilege for Actions:\n```yaml\npermissions:\n  contents: read\n```\n\n### Caching\n- Use built-in `actions/setup-*` caching where possible.\n- Prefer `npm ci` / `pnpm install --frozen-lockfile` to ensure deterministic installs.\n\n### Monorepo Considerations\n- If the project uses `packages/core` and `packages/cli`, run commands with `--workspaces` or set `working-directory` per job.\n- Optionally scope workflow with `paths` to avoid running on docs-only changes.\n\n### Naming\nThe **job id** becomes the **status check name** in the Ruleset. Use concise, stable ids:\n- `lint`, `typecheck`, `build`, `test`, `audit`\n\n### Example Workflow (Node.js / TypeScript, workspaces-friendly)\n```yaml\n# .github/workflows/ci.yml\nname: CI\n\non:\n  pull_request:\n    branches: [ main ]\n    # Optionally restrict files that trigger CI:\n    # paths: [ \"packages/**\", \".github/workflows/ci.yml\" ]\n  push:\n    branches: [ main ]\n\nconcurrency:\n  group: ci-${{ github.ref }}\n  cancel-in-progress: true\n\npermissions:\n  contents: read\n\njobs:\n  lint:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: npm\n      - run: npm ci\n      - run: npm run lint --workspaces --if-present\n      - run: npx prettier --check .\n\n  typecheck:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: npm\n      - run: npm ci\n      - run: npx tsc --noEmit || npx tsc -b --noEmit\n\n  build:\n    runs-on: ubuntu-latest\n    needs: [lint, typecheck]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: npm\n      - run: npm ci\n      - run: npm run build --workspaces --if-present\n      - uses: actions/upload-artifact@v4\n        with:\n          name: dist\n          path: |\n            packages/**/dist\n            !**/node_modules/**\n\n  test:\n    runs-on: ubuntu-latest\n    needs: build\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: npm\n      - run: npm ci\n      - run: npm test --workspaces --if-present -- --ci --reporters=default\n      # - run: npm test -- --coverage  # enable if you want coverage reports\n\n  audit:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: npm\n      - run: npm ci --omit=dev\n      - run: npm audit --audit-level=high\n```\n\n> Adapt commands to your package manager (`npm`, `pnpm`, `yarn`) and project structure. If some scripts are missing, remove those steps or add scripts in `package.json` (e.g., `lint`, `build`, `test`).\n\n### Paths Optimization (optional)\nIf the repo has docs or non-code folders, restrict triggers to relevant paths:\n```yaml\non:\n  pull_request:\n    branches: [ main ]\n    paths: [ \"packages/**\", \".github/workflows/ci.yml\" ]\n```\n\n### Secrets\nThis CI design **does not require secrets**. If tests need secrets, use repository or environment secrets and **do not** mark that job as required until secrets are stable.\n\n### Artifacts\nArtifacts (e.g., `dist/`) are uploaded for debugging; they are not released. Retention can be lowered to save storage.\n\n---\n\n## Ruleset Integration (Branch Protection)\n\nIn the Ruleset that targets `main`, ensure:\n- **Require a pull request before merging** → enabled (with at least 1 approval).\n- **Require status checks to pass** → enabled.\n- **Require branches to be up to date before merging** → enabled.\n- Select required checks: `lint`, `typecheck`, `build`, `test` (optionally `audit`).\n- **Block force pushes** and **Restrict deletions** → enabled.\n- **Require linear history** and **Require signed commits** → enabled per your policy.\n- Allow only **Squash** and **Rebase** merge methods for a clean history.\n\n---\n\n## Rollout Plan\n1. Create the workflow in a short-lived branch (`ci/bootstrap-ci`).\n2. Open a PR → confirm checks run and finish within the target time.\n3. Add the checks as **required** in the Ruleset (once they’re green).\n4. Merge the PR.\n5. Monitor subsequent PRs for false positives or performance issues.\n6. Iterate: add/remove optional checks (e.g., `audit`, `sizelimit`).\n\n---\n\n## Risks & Mitigations\n- **Slow CI**: Keep jobs parallel, cache dependencies, limit paths.\n- **Flaky tests**: Start with unit tests; quarantine flaky suites.\n- **Overly strict audit**: Start non-blocking; later make it required.\n- **Missing scripts**: Add minimal `lint`, `build`, `test` scripts in `package.json`.\n\n---\n\n## Metrics / Success Criteria\n- Median PR CI duration **≤ 10 minutes**.\n- 100% of merged PRs have all required checks green.\n- Zero unintended releases from PR pipelines.\n- Reduced post-merge failures on `main` (track incidents/regressions).\n\n---\n\n## Definition of Done\n- `.github/workflows/ci.yml` present and running on PRs.\n- Ruleset updated with selected jobs as required checks.\n- Documentation (this file) linked in the governance system/task.\n- Example PR demonstrating green checks.\n\n---\n\n## Governance Task Creation (example)\n\n**Title**: Establish PR CI pipeline and required checks for `main`  \n**Priority**: High  \n**Tags**: `ci`, `quality`, `governance`\n\n### Create via CLI (using a temp file in /tmp)\n```bash\ncat > /tmp/ci-task.md << 'EOF'\n# (Paste this whole document content here)\nEOF\n\ngitgov task new \"Establish PR CI pipeline and required checks for main\" \\\n  --description-file /tmp/ci-task.md \\\n  --priority high \\\n  --tags ci,quality,governance \\\n  --cleanup-file\n\n# Then follow workflow:\ngitgov task submit <task-id>    # send for review\ngitgov task approve <task-id>   # approve definition\ngitgov task activate <task-id>  # start implementation\n```",
    "tags": [
      "ci",
      "quality",
      "governance"
    ],
    "references": [],
    "cycleIds": [
      "1763344784-cycle-tareas-hurfanas-consolidadas"
    ]
  }
}