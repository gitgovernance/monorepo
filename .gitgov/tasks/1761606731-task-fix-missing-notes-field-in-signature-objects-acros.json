{
  "header": {
    "version": "1.0",
    "type": "task",
    "payloadChecksum": "3209028636f7a3b95d686ad5874207ac30caaff7541310c6a92ceb6d34a258d2",
    "signatures": [
      {
        "keyId": "human:camilo",
        "role": "author",
        "notes": "Signature regenerated by lint --fix",
        "signature": "3gQlTZFr2LlUayacWSHJL2n2f6NSe5k6COMQzRwk6Z5hfSkM7XacEuAy6dy1320OzJgNS0tl4wG0uU/Ke430DQ==",
        "timestamp": 1762658229
      },
      {
        "keyId": "human:camilo-v2",
        "role": "author",
        "notes": "Record signed",
        "signature": "keuQOchprlz0xXsv0tymhJKFs+gFrA56FD9cdO8KoYmiNlxD6bQGKa8E1lrhg9CPUxXJb0qH8b9ESYw5ebuTDg==",
        "timestamp": 1763344809
      }
    ]
  },
  "payload": {
    "id": "1761606731-task-fix-missing-notes-field-in-signature-objects-acros",
    "title": "Fix Missing notes Field in Signature Objects Across Tests",
    "status": "done",
    "priority": "high",
    "description": "# Fix Missing `notes` Field in Signature Objects Across Tests\n\n## Problem\n\nMultiple test files (31 tests failing) are creating signature objects that don't comply with `embedded_metadata_schema.yaml`. The schema requires the `notes` field in all signature objects, but many tests omit it.\n\n### Schema Requirement (embedded_metadata_schema.yaml:55-59)\n\n```yaml\nnotes:\n  type: string\n  minLength: 1\n  maxLength: 1000\n  description: \"Human-readable note from the signer. Part of the signature digest.\"\n```\n\n**Required fields:** keyId, role, **notes**, signature, timestamp, timestamp_iso\n\n### Current Violations\n\n**Example from CLI tests:**\n```typescript\n// ‚ùå INVALID (missing notes)\nsignatures: [{\n  keyId: 'human:test-user',\n  role: 'creator',\n  timestamp: new Date().toISOString(),\n  signature: 'test-signature'\n}]\n```\n\n**Example from Core validators:**\n```typescript\n// ‚ùå INVALID (missing notes)\nsignatures: [{ \n  keyId: 'human:test', \n  role: 'author', \n  signature: 'sig', \n  timestamp: 123, \n  timestamp_iso: '' \n}]\n```\n\n### Affected Files (28 total)\n\n**Core package (25 files):**\n- `packages/core/src/validation/*.test.ts` (9 files)\n- `packages/core/src/adapters/*/index.ts` (5 files)\n- `packages/core/src/adapters/*/*.test.ts` (10 files)\n- `packages/core/src/crypto/signatures.test.ts`\n- `packages/core/src/store/record_store.test.ts`\n\n**CLI package (3 files):**\n- `packages/cli/e2e/task_command_e2e.test.ts`\n- `packages/cli/e2e/dashboard_command_e2e.test.ts`\n- `packages/cli/e2e/diagram_command_e2e.test.ts`\n\n## Solution\n\n### Step 1: Audit All Signature Objects\n\nSearch for all occurrences of `signatures: [` in:\n- `packages/core/src/**/*.ts`\n- `packages/cli/**/*.ts`\n\n### Step 2: Add Missing `notes` Field\n\nFor each signature object, add the required `notes` field:\n\n```typescript\n// ‚úÖ VALID\nsignatures: [{\n  keyId: 'human:test-user',\n  role: 'creator',\n  notes: 'Test signature for unit testing',  // üëà ADD THIS\n  timestamp: new Date().toISOString(),\n  signature: 'test-signature'\n}]\n```\n\n**Guidelines for `notes` content:**\n- **Production code:** Use descriptive notes explaining the signature context\n- **Test code:** Use `''` (empty string) or simple descriptions like `'Test signature'`\n- **Examples (from schema):** Follow patterns in embedded_metadata_schema.yaml lines 190, 209, 215, 234, 240\n\n### Step 3: Special Cases\n\n**Case A: Type-casting signatures (tests)**\n```typescript\n// ‚úÖ Ensure all fields present before casting\nsignatures: [{\n  keyId: 'human:test',\n  role: 'author',\n  notes: '',  // Required even for test mocks\n  signature: 'sig',\n  timestamp: 123,\n  timestamp_iso: '2025-01-01T00:00:00Z'\n}] as [Signature, ...Signature[]]\n```\n\n**Case B: Dynamic signature creation**\n```typescript\n// ‚úÖ Ensure factory functions include notes\nconst signature = {\n  keyId: actorId,\n  role: 'author',\n  notes: '',  // Default for generated signatures\n  signature: 'placeholder',\n  timestamp: Date.now(),\n  timestamp_iso: new Date().toISOString()\n}\n```\n\n### Step 4: Verify TypeScript Compliance\n\nAfter changes, verify:\n```bash\ncd packages/core && npx tsc --noEmit\ncd packages/cli && npx tsc --noEmit\n```\n\n### Step 5: Run Tests\n\n```bash\ncd packages/core && pnpm test\ncd packages/cli && pnpm test:e2e\n```\n\n## Acceptance Criteria\n\n1. ‚úÖ All signature objects include the `notes` field\n2. ‚úÖ TypeScript compiles without errors\n3. ‚úÖ All tests pass (currently 728 passing ‚Üí 759 passing)\n4. ‚úÖ No implicit `any` types remain\n5. ‚úÖ Schema compliance verified in all production code\n\n## References\n\n- **Schema:** `packages/blueprints/03_products/protocol/01_embedded/embedded_metadata_schema.yaml`\n- **Examples:** Lines 188-249 in schema (shows proper `notes` usage)\n- **Related Issue:** This blocks proper signature verification in production\n\n## Estimated Effort\n\n- **Complexity:** Low (mechanical changes)\n- **Time:** 1-2 hours (28 files to update)\n- **Risk:** Low (purely additive change)",
    "tags": [
      "core",
      "cli",
      "testing",
      "schema-compliance"
    ],
    "references": [],
    "cycleIds": [
      "1763344784-cycle-tareas-hurfanas-consolidadas"
    ]
  }
}