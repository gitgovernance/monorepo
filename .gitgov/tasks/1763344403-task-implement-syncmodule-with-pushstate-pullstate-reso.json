{
  "header": {
    "version": "1.0",
    "type": "task",
    "payloadChecksum": "bcc50472ba8c13460b5968288c14a5a598eb40cba8018fc019360dd2c3b95609",
    "signatures": [
      {
        "keyId": "human:camilo-v2",
        "role": "author",
        "notes": "Record signed",
        "signature": "fddD2AKm8QobsfQ9+D/ghAKUvo5cpzByLGQtpJDAfXgUIzZYzWob+ibaMb+ilysgVZb6U3KrBeEpjtDfuGSWCA==",
        "timestamp": 1763344403
      },
      {
        "keyId": "human:camilo-v2",
        "role": "author",
        "notes": "Record signed",
        "signature": "L9w5lCztW0/rRfalijjiU7KQ2fU1OEH7Orju+CZ9FfYjathN8yyO/dcQoY7yiQa79jb17oxVLuKRO2Y/dkaiCA==",
        "timestamp": 1763344403
      },
      {
        "keyId": "human:camilo-v2",
        "role": "submitter",
        "notes": "Record signed",
        "signature": "/v1DTWnUUthIY7AtAbDKqXXJEBTm4k++WCglkiiSHR0yQTTjzG5OmxRqqCB4PEq5F9KWAsr8sXUUwmzQPbBDAg==",
        "timestamp": 1763462922
      },
      {
        "keyId": "human:camilo-v2",
        "role": "approver",
        "notes": "Record signed",
        "signature": "NDz78/VyyO8wzkwi+kzWbhqjIyFjs5KiIxmFElte2lk9zNOkT4dTxtJoDRUIRlmSH8FOGKeznlSiwIJGU85iBw==",
        "timestamp": 1763462931
      },
      {
        "keyId": "human:camilo-v2",
        "role": "executor",
        "notes": "Record signed",
        "signature": "EygTHUidhIwfzAvr6rHGi/spn0e+VLj4+z+f88iC7hi0I5XfzuK67arFPntGCPG5ojPSJAh1sqmAiz6HDyMaDA==",
        "timestamp": 1763462939
      },
      {
        "keyId": "human:camilo-v2",
        "role": "approver",
        "notes": "Record signed",
        "signature": "/MGZu/6TLiE8aTT15+ADLD0t19lzH28evRwxZbUsz1hxk9czPLhcKYgXiIiXuU1fH1ya10FE878jmIL2JmDJBw==",
        "timestamp": 1763597051
      }
    ]
  },
  "payload": {
    "id": "1763344403-task-implement-syncmodule-with-pushstate-pullstate-reso",
    "title": "Implement SyncModule with pushState, pullState, resolveConflict",
    "status": "done",
    "priority": "critical",
    "description": "# Task: Implement SyncModule with Full State Synchronization\n\nImplementar el m√≥dulo completo de sincronizaci√≥n de estado entre entorno local y rama `gitgov-state`, incluyendo todas las operaciones principales y el scheduler de pulls peri√≥dicos.\n\n## ‚úÖ PREREQUISITOS CUMPLIDOS\n\n- ‚úÖ **git_module** - Completado (42 operaciones at√≥micas, 47 tests)\n- ‚úÖ **crypto_module** - Implementado (checksum.ts, signatures.ts)\n- ‚úÖ **config_module** - Disponible para configuraci√≥n\n\n## üéØ ALCANCE: 40 EARS Totales\n\n**32 EARS - SyncModule Core:**\n- EARS 1-5: Gesti√≥n de rama gitgov-state\n- EARS 6-12: Operaci√≥n pushState (publicar cambios)\n- EARS 13-16: Operaci√≥n pullState (traer cambios)\n- EARS 17-23: Operaci√≥n resolveConflict (resolver conflictos)\n- EARS 24-31: Operaci√≥n auditState (verificar integridad)\n- EARS 32: Reservado\n\n**8 EARS - PullScheduler:**\n- EARS 33-40: Sincronizaci√≥n peri√≥dica en background\n\n## üìã OPERACIONES PRINCIPALES\n\n### 1. `ensureStateBranch()` - Setup Inicial\n**4 casos edge:**\n- Caso 1: No existe ni local ni remote ‚Üí Crear rama hu√©rfana + commit inicial + push\n- Caso 2: Existe remote, no local ‚Üí Fetch + create local + set tracking\n- Caso 3: Existe local, no remote ‚Üí Push + set tracking\n- Caso 4: Existe ambos ‚Üí Verificar tracking\n\n**Operaciones at√≥micas usadas:** 11 de git_module\n- `branchExists()`, `checkoutOrphanBranch()`, `checkoutFilesFromBranch()`\n- `commitAllowEmpty()`, `pushWithUpstream()`, `setUpstream()`\n- `fetch()`, `checkoutBranch()`, `getCurrentBranch()`, `hasUncommittedChanges()`, `add()`\n\n### 2. `pushState()` - Publicar Cambios Local ‚Üí Remote\n**3 Fases principales:**\n\n**Fase 0: Auditor√≠a Completa** (usando crypto_module)\n- Verificar resoluciones de conflictos pendientes\n- Validar firmas criptogr√°ficas en Records modificados\n- Verificar checksums SHA-256 de payloads\n- Detectar archivos esperados vs presentes\n\n**Fase 1: Reconciliaci√≥n Autom√°tica**\n- `ensureStateBranch()` - Asegurar rama existe\n- `git pull --rebase` - Traer cambios remotos primero (pull-before-push)\n- Detectar conflictos ‚Üí Abortar + Retornar ConflictInfo\n- Sin conflictos ‚Üí Continuar a Fase 2\n\n**Fase 2: Publicaci√≥n**\n- `calculateStateDelta()` - Determinar qu√© archivos cambiaron en `.gitgov/`\n- `checkoutFilesFromBranch()` - Copiar archivos modificados\n- `git commit` - Commit con actor y timestamp\n- `git push` - Subir a remote (retry 3√ó si falla)\n\n**Retorna:** `SyncPushResult` con `success`, `commitHash`, `filesSynced`, `conflictInfo`\n\n### 3. `pullState()` - Traer Cambios Remote ‚Üí Local\n**6 Pasos:**\n1. Pre-flight checks (no rebase en curso, gitgov-state existe)\n2. Save current branch (para rollback)\n3. Switch to gitgov-state\n4. `git pull --rebase` (reconciliar con remote)\n5. Detectar conflictos ‚Üí Pausar rebase + Retornar ConflictInfo\n6. Sin conflictos ‚Üí Determinar si re-indexar + Retornar resultado\n\n**Retorna:** `SyncPullResult` con `success`, `hasChanges`, `reindexed`, `conflictInfo`\n\n### 4. `resolveConflict()` - Resolver Conflictos Durante Rebase\n**Pipeline de resoluci√≥n:**\n1. Verificar que hay rebase en curso (`.git/rebase-merge/`)\n2. `checkConflictMarkers()` - Verificar que no quedan marcadores `<<<<<<<`\n3. Actualizar Records resueltos:\n   - Recalcular `payloadChecksum` usando crypto_module\n   - Agregar nueva firma del actor que resolvi√≥\n4. `git add` + `git rebase --continue` (commit t√©cnico)\n5. Crear commit de resoluci√≥n firmado con `crypto_module.signPayload()`\n6. Retornar informaci√≥n del commit de resoluci√≥n\n\n**Retorna:** `SyncResolveResult` con `success`, `resolutionCommitHash`, `conflictsResolved`\n\n### 5. `auditState()` - Verificaci√≥n de Integridad\n**Verificaciones usando crypto_module:**\n- ‚úÖ Resoluciones pendientes (rebase en curso sin finalizar)\n- ‚úÖ Firmas criptogr√°ficas v√°lidas usando `verifySignatures()`\n- ‚úÖ Checksums SHA-256 correctos usando `calculatePayloadChecksum()`\n- ‚úÖ Archivos esperados presentes en `.gitgov/`\n\n**Retorna:** `AuditStateReport` con lista de violaciones encontradas\n\n### 6. PullScheduler - Sincronizaci√≥n Peri√≥dica\n**Funcionalidad:**\n- `start()` / `stop()` / `isRunning()` - Control del scheduler\n- Ejecuta `pullState()` cada N segundos (configurable)\n- Emite eventos: `state.updated`, `conflict.detected` (si hay EventBus)\n- Manejo de errores de red (continuar o detener seg√∫n config)\n- Previene pulls concurrentes (skip si ya hay uno corriendo)\n\n## üí° PATRONES DE IMPLEMENTACI√ìN\n\n**Patr√≥n:** Pipeline Pattern\n- Cada operaci√≥n tiene fases secuenciales\n- Validaci√≥n en cada fase (fail-fast)\n- Rollback autom√°tico en caso de error\n\n**Ubicaci√≥n:** `packages/core/src/modules/sync/`\n```\nsync/\n‚îú‚îÄ‚îÄ sync_module.ts         # SyncModule class (operaciones 1-5)\n‚îú‚îÄ‚îÄ pull_scheduler.ts      # PullScheduler class\n‚îú‚îÄ‚îÄ types.ts               # Interfaces y tipos\n‚îú‚îÄ‚îÄ errors.ts              # Errores tipados\n‚îú‚îÄ‚îÄ sync_module.test.ts    # Tests EARS 1-32\n‚îî‚îÄ‚îÄ pull_scheduler.test.ts # Tests EARS 33-40\n```\n\n**Constructor:** Dependency Injection\n```typescript\nconstructor(dependencies: {\n  git: GitModule;           // ‚úÖ Implementado\n  crypto: CryptoModule;     // ‚úÖ Implementado\n  config: ConfigManager;    // ‚úÖ Disponible\n  eventBus?: EventBus;      // Opcional (graceful degradation)\n  logger?: Logger;          // Opcional (graceful degradation)\n})\n```\n\n## ‚úÖ CRITERIOS DE ACEPTACI√ìN\n\n**SyncModule Core:**\n- [ ] `ensureStateBranch()` - 4 casos edge cubiertos\n- [ ] `pushState()` - 3 fases completas con auditor√≠a\n- [ ] `pullState()` - 6 pasos con manejo de conflictos\n- [ ] `resolveConflict()` - Actualizaci√≥n de Records + firmas\n- [ ] `auditState()` - 4 tipos de verificaci√≥n\n- [ ] 32 tests pasando (EARS 1-32)\n\n**PullScheduler:**\n- [ ] `start()` / `stop()` / `isRunning()` funcionales\n- [ ] Pulls peri√≥dicos sin bloqueo\n- [ ] Eventos emitidos correctamente\n- [ ] Manejo de errores de red\n- [ ] Prevenci√≥n de concurrencia\n- [ ] 8 tests pasando (EARS 33-40)\n\n**Total: 40 tests (100% cobertura EARS)**\n\n## üìö REFERENCIAS\n\n- **Blueprint:** `sync_module.md` (3213 l√≠neas, 40 EARS)\n- **Dependencies:** \n  - ‚úÖ `git_module.md` - Operaciones Git de bajo nivel\n  - ‚úÖ `crypto_module.md` - Firmas y checksums\n- **Protocolo:** `state_sync.md` - Reglas de sincronizaci√≥n\n- **Implementaci√≥n crypto:** `checksum.ts`, `signatures.ts`\n\n## ‚è±Ô∏è ESTIMACI√ìN\n\n**3-4 d√≠as** (considerando que git_module y crypto_module ya est√°n listos)\n\n- D√≠a 1: ensureStateBranch + calculateStateDelta + tests (EARS 1-5)\n- D√≠a 2: pushState + auditState + tests (EARS 6-12, 24-31)\n- D√≠a 3: pullState + resolveConflict + tests (EARS 13-23)\n- D√≠a 4: PullScheduler + tests finales (EARS 33-40)",
    "tags": [
      "category:feature",
      "cycle:01",
      "package:core",
      "skill:typescript",
      "skill:git"
    ],
    "cycleIds": [
      "1763344330-cycle-cycle-1-syncmodule-basic---manual-sync"
    ],
    "references": [
      "file:packages/blueprints/03_products/core/specs/modules/sync_module/sync_module.md",
      "file:packages/blueprints/03_products/core/specs/modules/git_module/git_module.md",
      "file:packages/blueprints/03_products/protocol/99_appendices/state_sync.md"
    ]
  }
}