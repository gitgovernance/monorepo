{
  "header": {
    "version": "1.0",
    "type": "task",
    "payloadChecksum": "005a1991b8b6a6114505fec193d2a73623201a2c587a6c7f5a0b37bb171f55c6",
    "signatures": [
      {
        "keyId": "human:camilo",
        "role": "author",
        "notes": "Signature regenerated by lint --fix",
        "signature": "eNSkeM0z+K4wF94rzYtIYhwB77pRxMWgLXKVbp/dPGnLI6fY5QBmNnRpEgDhCZyGSmkI3rmJVkGxQaaASJ+NBw==",
        "timestamp": 1762658229
      },
      {
        "keyId": "human:camilo-v2",
        "role": "author",
        "notes": "Record signed",
        "signature": "+ytPd1CEgGFfCsPv4QobLwZlfDUz4eOF+0/kgGsh9kvPeK7mznndd70JpKpO4RvCCf51bWGSaoIReQYJKXFuCw==",
        "timestamp": 1763344809
      }
    ]
  },
  "payload": {
    "id": "1761603296-task-implementar-ears-36-y-testing-avanzado-del-feedbac",
    "title": "Implement EARS-36 and Advanced Testing for FeedbackAdapter",
    "status": "paused",
    "priority": "high",
    "description": "# Implementar EARS-36 y Testing Avanzado del FeedbackAdapter\n\n## Contexto\n\nEl `FeedbackAdapter` está implementado con 6/6 métodos funcionando y 20/36 EARS cubiertos. Faltan 16 EARS relacionados con:\n- Event emission verification (EARS-20, 21, 22)\n- Edge cases del patrón inmutable (EARS-23, 24, 25, 36)\n- Threading avanzado (EARS-26, 27)\n- Performance con datasets grandes (EARS-29, 30)\n- Integration tests con BacklogAdapter REAL (EARS-31 a 35)\n\n## Problema\n\n### EARS-36: Assignment Resolution Detection\n\n**Situación actual:** La validación de duplicate assignment solo verifica `status === 'open'`, pero en el patrón inmutable, los feedbacks nunca cambian de status. Cuando un assignment se \"resuelve\" con `resolve()`, el assignment original SIGUE con `status: 'open'` (inmutable), y se crea un NUEVO feedback con `resolvesFeedbackId`.\n\n**Problema:** Al intentar re-asignar a un actor que completó su trabajo previo, se detecta como duplicado incorrectamente.\n\n**Solución necesaria:** Verificar si existe una resolución del assignment (feedback con `resolvesFeedbackId` apuntando al assignment original).\n\n### Tests Faltantes\n\n16 tests unitarios/integración/performance faltantes para alcanzar 100% coverage de los 36 EARS documentados.\n\n## Solución\n\n### 1. Actualizar Validación de Duplicate Assignment (EARS-36)\n\n**Archivo:** `packages/core/src/adapters/feedback_adapter/index.ts`\n\n**Cambio en método `create()`:**\n\n```typescript\n// Línea ~101-112\nif (payload.type === 'assignment' && payload.assignee) {\n  const existingFeedbacks = await this.getFeedbackByEntity(payloadWithEntityId.entityId);\n  \n  // Buscar assignments abiertos para el mismo actor\n  const openAssignments = existingFeedbacks.filter(f =>\n    f.type === 'assignment' &&\n    f.assignee === payload.assignee &&\n    f.status === 'open'\n  );\n  \n  // Para cada assignment abierto, verificar si tiene resolución\n  for (const assignment of openAssignments) {\n    const hasResolution = existingFeedbacks.some(f =>\n      f.entityType === 'feedback' &&\n      f.resolvesFeedbackId === assignment.id &&\n      f.status === 'resolved'\n    );\n    \n    if (!hasResolution) {\n      // Assignment abierto SIN resolución → duplicado\n      throw new Error(`DuplicateAssignmentError: Task ${payloadWithEntityId.entityId} is already assigned to ${payload.assignee} (feedback: ${assignment.id})`);\n    }\n  }\n}\n```\n\n**Ventaja:** Permite re-asignar después de `resolve()` manteniendo inmutabilidad total.\n\n### 2. Implementar Tests Faltantes\n\n#### A. Event Emission Tests (EARS-20, 21, 22)\n\n**Archivo:** `packages/core/src/adapters/feedback_adapter/feedback_adapter.test.ts`\n\n```typescript\ndescribe('Event Emission Verification', () => {\n  it('[EARS-20] should emit feedback.created with resolvesFeedbackId when present');\n  it('[EARS-21] should emit feedback.created with assignee when provided');\n  it('[EARS-22] should emit feedback.created via resolve with resolvesFeedbackId populated');\n});\n```\n\n**Ya implementados** ✅ - Solo necesitan verificarse.\n\n#### B. Edge Cases (EARS-23, 24, 25, 36)\n\n```typescript\ndescribe('Edge Cases - Immutable Pattern', () => {\n  it('[EARS-23] should accept feedback on cycle entities');\n  it('[EARS-24] should allow resolving same feedback multiple times without conflict');\n  it('[EARS-25] should allow creating feedback with resolved status from start');\n  it('[EARS-36] should detect assignment resolution via resolvesFeedbackId');\n});\n```\n\n**EARS-23, 24, 25 ya implementados** ✅  \n**EARS-36 pendiente** ❌\n\n#### C. Threading Edge Cases (EARS-26, 27)\n\n```typescript\ndescribe('Threading Edge Cases', () => {\n  it('[EARS-26] should return empty thread for feedback with no responses');\n  it('[EARS-27] should build deep thread (10+ levels) without performance degradation');\n});\n```\n\n**Ya implementados** ✅\n\n#### D. Performance (EARS-29, 30)\n\n```typescript\ndescribe('Performance - Advanced', () => {\n  it('[EARS-29] should filter 1000+ feedbacks in under 100ms');\n  it('[EARS-30] should build thread of 20+ levels in under 200ms');\n});\n```\n\n**Ya implementados** ✅\n\n#### E. Integration Tests (EARS-31 a 35)\n\n**Archivo:** `packages/core/src/integration/feedback_backlog_integration.test.ts`\n\n```typescript\ndescribe('FeedbackAdapter <-> BacklogAdapter Integration', () => {\n  it('[EARS-31] should pause task when blocking feedback created (real adapters)');\n  it('[EARS-32] should resume task when last blocking feedback resolved (real adapters)');\n  it('[EARS-33] should keep task paused with multiple blocking feedbacks (real adapters)');\n  it('[EARS-34] should prevent duplicate assignments in getTasksAssignedToActor flow');\n  it('[EARS-35] should allow re-assignment after resolving previous assignment');\n});\n```\n\n**Estado:**\n- EARS-31, 34: ✅ PASANDO\n- EARS-32, 33, 35: ❌ FALLANDO (esperan EARS-36)\n\n### 3. Verificación Completa\n\n**Después de implementar:**\n\n```bash\n# 1. Verificar TypeScript compila\ncd packages/core && npx tsc --noEmit\n\n# 2. Ejecutar tests unitarios\npnpm test feedback_adapter.test.ts\n# Esperado: 36 tests pasando (era 26, agregamos 10)\n\n# 3. Ejecutar tests de integración\npnpm test feedback_backlog_integration.test.ts\n# Esperado: 5 tests pasando (ahora 2/5, después de EARS-36: 5/5)\n\n# 4. Ejecutar todos los tests del core\npnpm test\n# Esperado: 752 tests pasando (742 actuales + 10 nuevos)\n```\n\n## Referencias Técnicas\n\n**Especificaciones:**\n- Blueprint: `packages/blueprints/03_products/core/specs/adapters/feedback_adapter.md`\n- FAQ: `packages/blueprints/03_products/core/specs/adapters/feedback_adapter_faq.md` (FAQ #15)\n- EARS Detallados: Líneas 371-383 (feedback_adapter.md)\n- Algoritmo: Líneas 323-328 (feedback_adapter.md)\n\n**Archivos a Modificar:**\n- `packages/core/src/adapters/feedback_adapter/index.ts` (líneas 99-112)\n- `packages/core/src/adapters/feedback_adapter/feedback_adapter.test.ts` (agregar test EARS-36)\n- `packages/core/src/integration/feedback_backlog_integration.test.ts` (fix tests existentes)\n\n**EARS Coverage:**\n- Antes: 20/36 EARS (55%)\n- Después: 36/36 EARS (100%)\n\n## Criterios de Aceptación\n\n1. ✅ EARS-36 implementado: lógica de detección de resolución funciona\n2. ✅ Test EARS-36 pasa: re-assignment después de resolve() funciona\n3. ✅ Tests EARS-20 a EARS-30 pasan: 11 tests (ya implementados, solo verificar)\n4. ✅ Tests EARS-31 a EARS-35 pasan: 5 integration tests funcionan\n5. ✅ Total 36/36 tests de FeedbackAdapter pasando\n6. ✅ Integration tests (5) pasando con adapters REALES\n7. ✅ TypeScript sin errores\n8. ✅ Todos los tests del core (752+) siguen pasando\n\n## Estimación\n\n**Complejidad:** Media  \n**Tiempo estimado:** 2-3 horas  \n**Prioridad:** High (crítico para coherencia arquitectural)  \n**Tags:** `core`, `feedback-adapter`, `testing`, `immutable-pattern`",
    "tags": [
      "core",
      "feedback-adapter",
      "testing",
      "immutable-pattern"
    ],
    "references": [],
    "cycleIds": [
      "1763344784-cycle-tareas-hurfanas-consolidadas"
    ]
  }
}