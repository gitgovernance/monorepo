{
  "header": {
    "version": "1.0",
    "type": "task",
    "payloadChecksum": "afeac075a0d3a0c4581008382bbd11b70446a1b0347153fbb31b333e298c1f61",
    "signatures": [
      {
        "keyId": "human:camilo",
        "role": "author",
        "notes": "Task created",
        "signature": "idgRSZuzTFA1IFO4m0bm9sRck1UzCYratWzMloBN8ShLVdyvpjT+/lx/ogpMC1Bjp01WIJ5qYuMK6hkpK20gBQ==",
        "timestamp": 1762658229
      },
      {
        "keyId": "human:camilo-v2",
        "role": "approver",
        "notes": "Record signed",
        "signature": "W8GjrzaCpZCHqlZ4LCK3N3vJx6W2WVA0HCrtARcBMR99cnyn7r+0W4yKtOvZffVSPPWNQBBIb8fQEmKOpcRJAg==",
        "timestamp": 1762669154
      },
      {
        "keyId": "human:camilo-v2",
        "role": "author",
        "notes": "Record signed",
        "signature": "PQn44zwMsQvJEIH0pkpFHEH66lccUUuit9a8Cb7wjJ4UTft3bNlfBR4XY7zVR208GmNx9PAI9Zq/mT0PyYnmAA==",
        "timestamp": 1763344818
      }
    ]
  },
  "payload": {
    "id": "1762449462-task-add-load-validation-methods-to-record-factories",
    "title": "Add load() validation methods to Record Factories",
    "status": "done",
    "priority": "high",
    "description": "# Add load() validation methods to Record Factories\n\n## Problem\n\nCurrently, `RecordStore.read()` uses unsafe type assertions without validation:\n\n```typescript\n// packages/core/src/store/record_store.ts:58\nconst record = JSON.parse(content) as GitGovRecord & { payload: T };\nreturn record; // ❌ TYPE ASSERTION, NOT VALIDATION\n```\n\nThis causes runtime crashes when reading files with invalid/corrupted schemas (e.g., missing `relatedTasks` in changelogs).\n\n**Current architecture:**\n- ✅ **CREATE**: Factories validate using `validateXRecordDetailed()` \n- ❌ **READ**: RecordStore does NOT validate (just casts)\n\nThis gap caused indexer crash: `Cannot read properties of undefined (reading 'includes')` when changelog files lacked `relatedTasks` field.\n\n## Solution\n\nImplement **Hydration Pattern** with `load()` methods in factories:\n\n1. **Factory** provides validation logic via `loadXRecord(data: unknown): XRecord`\n2. **RecordStore** receives loader as dependency and uses it in `read()`\n3. **Adapters** pass loaders when constructing RecordStores\n\n**Benefits:**\n- Centralized validation in factories (create + load)\n- RecordStore remains generic\n- Type-safe data loading\n- Early detection of schema violations\n\n---\n\n## Implementation Steps\n\n### **Phase 1: Add load() methods to factories**\n\nCreate `loadXRecord()` functions in all factories:\n\n**Files to update:**\n- `packages/core/src/factories/task_factory.ts`\n- `packages/core/src/factories/cycle_factory.ts`\n- `packages/core/src/factories/changelog_factory.ts`\n- `packages/core/src/factories/feedback_factory.ts`\n- `packages/core/src/factories/execution_factory.ts`\n- `packages/core/src/factories/actor_factory.ts`\n\n**Pattern:**\n```typescript\n// Example: packages/core/src/factories/task_factory.ts\n\nexport function loadTaskRecord(data: unknown): TaskRecord {\n  const validation = validateTaskRecordDetailed(data);\n  if (!validation.isValid) {\n    throw new DetailedValidationError('TaskRecord', validation.errors);\n  }\n  return data as TaskRecord;\n}\n```\n\n### **Phase 2: Update RecordStore to accept loader**\n\n**File:** `packages/core/src/store/record_store.ts`\n\n**Changes:**\n1. Add `loader` parameter to constructor:\n```typescript\nconstructor(\n  recordType: string,\n  private loader: (data: unknown) => T,  // NEW\n  rootPath?: string,\n  fsDeps: FsDependencies = fs\n)\n```\n\n2. Use loader in `read()` method:\n```typescript\nasync read(recordId: string): Promise<(GitGovRecord & { payload: T }) | null> {\n  const content = await this.fs.readFile(filePath, 'utf-8');\n  const raw = JSON.parse(content);\n  \n  // Validate payload using loader\n  try {\n    const payload = this.loader(raw.payload);\n    return { header: raw.header, payload };\n  } catch (error) {\n    console.warn(`⚠️  Invalid record ${recordId}:`, error);\n    return null; // Skip invalid records\n  }\n}\n```\n\n### **Phase 3: Update all adapters to pass loaders**\n\n**Files to update:**\n- `packages/core/src/adapters/backlog_adapter/index.ts`\n- `packages/core/src/adapters/changelog_adapter/index.ts`\n- `packages/core/src/adapters/feedback_adapter/index.ts`\n- `packages/core/src/adapters/execution_adapter/index.ts`\n- `packages/core/src/adapters/indexer_adapter/index.ts`\n- `packages/core/src/adapters/identity_adapter/index.ts`\n\n**Pattern:**\n```typescript\n// Example: backlog_adapter/index.ts\n\nimport { loadTaskRecord } from '../factories/task_factory';\nimport { loadCycleRecord } from '../factories/cycle_factory';\n\nconstructor(dependencies: BacklogAdapterDependencies) {\n  this.taskStore = new RecordStore<TaskRecord>(\n    'tasks',\n    loadTaskRecord,  // ← Pass loader\n    rootPath\n  );\n  \n  this.cycleStore = new RecordStore<CycleRecord>(\n    'cycles',\n    loadCycleRecord,  // ← Pass loader\n    rootPath\n  );\n}\n```\n\n### **Phase 4: Add integration tests**\n\n**New file:** `packages/core/src/store/record_store.integration.test.ts`\n\n**Tests:**\n1. Read valid record → should succeed\n2. Read invalid record (missing required field) → should return null + warn\n3. Read corrupted JSON → should handle gracefully\n4. Read record with schema violation → should detect and warn\n\n**New file:** `packages/core/src/adapters/indexer_adapter/indexer_adapter.integration.test.ts`\n\n**Tests:**\n1. Index generation with real `.gitgov/` files\n2. Invalid changelogs → should be skipped with warnings\n3. Invalid tasks → should be filtered out\n4. System should NOT crash on schema violations\n\n---\n\n## Acceptance Criteria\n\n✅ **Phase 1:** All 6 factories have `loadXRecord()` methods with validation  \n✅ **Phase 2:** RecordStore.read() validates using loader  \n✅ **Phase 3:** All 6 adapters pass loaders to RecordStores  \n✅ **Phase 4:** 8+ integration tests passing  \n✅ **Result:** `gitgov indexer` runs without crashes on invalid data  \n✅ **Result:** Console shows warnings for invalid records (not silent failures)  \n✅ **Result:** All existing tests still pass  \n\n---\n\n## Files to Modify\n\n**Factories (6 files):**\n- packages/core/src/factories/task_factory.ts\n- packages/core/src/factories/cycle_factory.ts\n- packages/core/src/factories/changelog_factory.ts\n- packages/core/src/factories/feedback_factory.ts\n- packages/core/src/factories/execution_factory.ts\n- packages/core/src/factories/actor_factory.ts\n\n**Core (1 file):**\n- packages/core/src/store/record_store.ts\n\n**Adapters (6 files):**\n- packages/core/src/adapters/backlog_adapter/index.ts\n- packages/core/src/adapters/changelog_adapter/index.ts\n- packages/core/src/adapters/feedback_adapter/index.ts\n- packages/core/src/adapters/execution_adapter/index.ts\n- packages/core/src/adapters/indexer_adapter/index.ts\n- packages/core/src/adapters/identity_adapter/index.ts\n\n**Tests (2 new files):**\n- packages/core/src/store/record_store.integration.test.ts\n- packages/core/src/adapters/indexer_adapter/indexer_adapter.integration.test.ts",
    "tags": [
      "validation",
      "core",
      "factories",
      "record-store",
      "testing",
      "schema"
    ],
    "references": [
      "task:1758522352-task-implement-authorlastmodifier-enrichment-in-indexer",
      "pr:https://github.com/gitgovernance/monorepo/pull/54"
    ],
    "cycleIds": [
      "1763344784-cycle-tareas-hurfanas-consolidadas"
    ]
  }
}